<!DOCTYPE html>
<html>
	<head>
		<title>three.js css3d - periodic table</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="stylesheet" href="CSS/Lottery_matrix.css">
	</head>
	<body>
		<script src="js/three.js"></script>
		<script src="js/tween.min.js"></script>
		<script src="js/TrackballControls.js"></script>
		<script src="js/CSS3DRenderer.js"></script>

		<div id="container"></div>
		<div id="menu">
            <div class="opt-menu">
                <button id="stop" class="dhidden btn-stop">停止</button>
                <button id="start" class="btn-start">开始</button>
            </div>
		</div>
		<script>
			var camera, scene, renderer;
			var controls;

			var objects = [];
			var targets = { table: [], sphere: [], helix: [], grid: [] };

			init();
			animate();

			function init() {

				camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 ); // 角度 宽高比 近裁剪面  远裁剪面
				camera.position.z = 1400;

				scene = new THREE.Scene(); // 这里是创建一个场景

				// 这里随机创建初始信息
                createMatrix(2000);
                createMatrix(1000);
                createMatrix(0);
                createMatrix(-1000);
                createMatrix(-2000);
                createMatrix(-3000);
                createMatrix(-4000);

                createMatrix(-5000);

				renderer = new THREE.CSS3DRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.domElement.style.position = 'absolute';
				document.getElementById( 'container' ).appendChild( renderer.domElement );

				//

				controls = new THREE.TrackballControls( camera, renderer.domElement );
				controls.rotateSpeed = 0.5;
				controls.minDistance = 500;
				controls.maxDistance = 6000;
				controls.addEventListener( 'change', render );

                // 变换至grid

                for ( var i = 0; i < targets.grid.length; i ++ ) {
                    targets.grid[i].position.x = targets.grid[i].position.x;
                    targets.grid[i].position.y = targets.grid[i].position.y;
                    targets.grid[i].position.z = targets.grid[i].position.z;
                }

                transform( targets.grid, 2000 );

                var timer = null
                var around_time = 3;
                var circle_time = 500;
                document.getElementById('start').addEventListener('click', function (event) {

                    timer = setInterval(function () {
                        createMatrix(-5000);

                        for ( var i = 0; i < targets.grid.length; i ++ ) {
                            targets.grid[i].position.x = targets.grid[i].position.x;
                            targets.grid[i].position.y = targets.grid[i].position.y;
                            targets.grid[i].position.z = targets.grid[i].position.z;
                        }

                        transformStaticTime( targets.grid, circle_time );
                        for(let i = 0 ; i < 25; i++){
                            scene.remove(objects[0]);
                            targets.grid.pop(objects[0]);
                            objects.splice(0 ,1);
                        }
                        console.log(around_time);
                    }, circle_time)
                }, false)

                document.getElementById('stop').addEventListener('click', function (event) {
                    clearInterval(timer);
                }, false)

				// 监听浏览器窗口大小变化

				window.addEventListener( 'resize', onWindowResize, false );

			}


            // 随机动画时间
			function transform( targets, duration ) {

				TWEEN.removeAll();

				for ( var i = 0; i < objects.length; i ++ ) {

					var object = objects[ i ];
					var target = targets[ i ];

					new TWEEN.Tween( object.position )
						.to( {
                            x: target.position.x,
                            y: target.position.y,
                            z: target.position.z }, Math.random() * duration + duration )
						.easing( TWEEN.Easing.Exponential.InOut )
						.start();

				}

				new TWEEN.Tween( this )
					.to( {}, duration * 2 )
					.onUpdate( render )
					.start();

			}

            // 固定动画时间
            function transformStaticTime( targets, duration){
                TWEEN.removeAll();

                for ( var i = 0; i < objects.length; i ++ ) {

                    var object = objects[ i ];
                    var target = targets[ i ];

                    new TWEEN.Tween( object.position )
                            .to( {
                                x: target.position.x,
                                y: target.position.y,
                                z: target.position.z }, duration )
                            .easing( TWEEN.Easing.Linear.None )
                            .start();

                }

                new TWEEN.Tween( this )
                        .to( {}, duration * 2 )
                        .onUpdate( render )
                        .start();
            }

            function createMatrix(zPosition) {
                // 添加层
                for ( var i = 0; i < 25 ; i ++ ) {

                    if( i == 12){
                        var element = document.createElement( 'div' );
                        element.className = 'element';
                        element.style.backgroundColor = 'transparent';
                        element.style.borderColor = 'transparent';
                        element.style.boxShadow = 'none';

                        var object = new THREE.CSS3DObject( element );
                        object.position.x = ( i % 5 ) * 400 - 800;
                        object.position.y = 800 - Math.floor( i / 5 ) * 400;
                        object.position.z = zPosition;
                    }else{
                        var element = document.createElement( 'div' );
                        element.className = 'element';
                        element.style.backgroundColor = 'rgba(0,127,127, 0.3)';

                        var number = document.createElement( 'div' );
                        number.className = 'number';
                        number.textContent = Math.random().toFixed(2);
                        element.appendChild( number );

                        var symbol = document.createElement( 'div' );
                        symbol.className = 'symbol';
                        symbol.textContent = Math.random().toFixed(2);
                        element.appendChild( symbol );

                        var details = document.createElement( 'div' );
                        details.className = 'details';
                        details.innerHTML = Math.random().toFixed(2) + '<br>' + Math.random().toFixed(2);
                        element.appendChild( details );

                        var object = new THREE.CSS3DObject( element );
                        object.position.x = ( i % 5 ) * 400 - 800;
                        object.position.y = 800 - Math.floor( i / 5 ) * 400;
                        object.position.z = zPosition;
                    }

                    scene.add( object );
                    objects.push( object );
                }

                for ( var i = 0; i < 25; i ++ ) {

                    var object = new THREE.Object3D();

                    object.position.x = ( i % 5 ) * 400 - 800;
                    object.position.y = 800 - Math.floor( i / 5 ) * 400;
                    object.position.z = zPosition;

                    targets.grid.push( object );

                }
            }

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}

			function animate() {

				requestAnimationFrame( animate );

				TWEEN.update();

				controls.update();

			}

			function render() {

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
